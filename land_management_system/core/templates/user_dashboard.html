{% load static %}
<!DOCTYPE html>
<html>
  <head>
    <title>User Dashboard</title>
    <link rel="stylesheet" type="text/css" href="{% static 'css/style.css' %}" />
    <script src="https://cdn.jsdelivr.net/npm/@metamask/detect-provider/dist/index.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.3.0/web3.min.js"></script>
  </head>
  <body>
    <div style="display: none;">
      Contract Address:<div id="debugContractAddress">{{ contract_address }}</div>ABI:<div id="debugABI">{{ abi|safe }}</div>
    </div>
    <div class="dashboard-container">
      <h1>Welcome to Your Dashboard, {{ request.user.username }}</h1>
      <div class="logout-button">
        <a href="{% url 'user_logout' %}" class="btn-logout">Logout</a>
      </div>
      <h2>Your Lands</h2>
      {% if lands %}
        <table>
          <thead>
            <tr>
              <th>Tehsil</th>
              <th>Khasra Number</th>
              <th>Division</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            {% for land in lands %}
              <tr>
                <td>{{ land.land.tehsil }}</td>
                <td>{{ land.land.khasra_number }}</td>
                <td>{{ land.land.division }}</td>
                <td>
                  <button onclick="transferLand({{ land.id }}, '{{ land.transferee_user.wallet_address }}')">Transfer</button>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <p>No lands available where taxes are fully paid.</p>
      {% endif %}
    </div>

    <script>
      // Ensure that MetaMask is installed
      detectEthereumProvider()
        .then((provider) => {
          if (provider) {
            console.log('Ethereum successfully detected!')
            // You can now initialize your application
          } else {
            console.error('Please install MetaMask!')
          }
        })
        .catch((error) => {
          console.error('An error occurred:', error)
        })
      
      async function connectWallet() {
        const provider = await detectEthereumProvider()
        if (provider) {
          try {
            await provider.request({ method: 'eth_requestAccounts' })
            return new Web3(provider)
          } catch (error) {
            console.error('Failed to connect wallet:', error)
            alert('Failed to connect wallet. Check the console for more details.')
            return null
          }
        } else {
          alert('MetaMask is not installed. Please install MetaMask to interact.')
          return null
        }
      }
      
      async function transferLand(landId, receiverWalletAddress) {
        const web3 = await connectWallet()
        if (!web3) {
          console.log('Wallet connection failed or was denied by user.')
          return
        }
      
        const contractAddress = document.getElementById('debugContractAddress').innerText.trim()
        const abi = JSON.parse(document.getElementById('debugABI').innerText.trim())
        const contract = new web3.eth.Contract(abi, contractAddress)
        const accounts = await web3.eth.getAccounts()
        const fromAddress = accounts[0] // Using the first account in MetaMask
      
        console.log(`Initiating transfer: landId=${landId}, receiverWalletAddress=${receiverWalletAddress}`)
        console.log('Transferor Address:', fromAddress)
      
        const response = await fetch("{% url 'transfer_nft' %}", {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
          },
          body: JSON.stringify({
            land_id: landId,
            receiver_wallet_address: receiverWalletAddress,
            from_address: fromAddress
          })
        })
      
        if (response !== null && response !== undefined) {
          const result = await response.json()
          console.log(`Transfer result: ${JSON.stringify(result)}`)
          if (result.status === 'success') {
            alert('Transfer successful!')
          } else {
            alert(`Error during transfer: ${result.message}`)
          }
        }
      }
      
      window.ethereum.on('accountsChanged', (accounts) => {
        if (accounts.length === 0) {
          console.log('Please connect to MetaMask.')
        } else {
          console.log('Account changed:', accounts[0])
        }
      })
      
      window.ethereum.on('chainChanged', (_chainId) => window.location.reload())
      
      console.log('Contract Address:', document.getElementById('debugContractAddress').innerText)
      console.log('ABI:', JSON.parse(document.getElementById('debugABI').innerText))
    </script>
  </body>
</html>
